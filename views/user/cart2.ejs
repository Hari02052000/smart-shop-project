




<%-include('../user/layout/user-header-layout.ejs') -%>


  <div >
    <div class>
      <div class>
        
        <% if (usercart.cart.length == 0) { %>
          <div class>
            <img src="https://ibellstore.com/images/no-item-found-here.png" alt="no order" style="width: 400px; height:300px ;">
          </div>
          <% } else { %>
        <div class="table-responsive">
          <table class="table">
            <thead>
              <tr>
                <th scope="col"></th>
                <th scope="col" id="one">product name</th>
                <th scope="col">price</th>
                <th scope="col">quantity</th>
                <th scope="col"></th>
              </tr>
            </thead>
            <tbody>
              <% usercart.cart.forEach(function(x) { %>
                <tr id="productRow_<%=x.product._id%>">
                  
                    
                  <td >
                  <img src="/images/products/<%= x.product.images[0] %>" style="width: 200px; height: 200px;">  
                  </td>
                  <td>
                    <div class="media-body">
                    <p> <%=x.product.productName%></p>
                    </div>
                  </td>
                  <td id="price_<%=x.product._id%>" >
                    <%=x.product.price%>                     
                  </td>
                  <td>
                    <button onclick="changeCount('<%=x.product._id%>','sub')">-</button><input type="number" min="1" value="<%=x.quantity%>" id="quantity_<%=x.product._id%>" disabled>  <button  onclick="changeCount('<%=x.product._id%>','add')">+</button>
                  </td>
                  <td id="subtotel_<%=x.product._id%>" class="newprice">
                    <%=x.quantity%>*<%=x.product.price%> = <%=x.product.newprice%>
                  </td>
                  <td>
                    <form action="/removeCart?product=<%=x.product._id%>" method="post">
                     <button onclick="removeCart(event,'<%=x.product.productName%>')" type="submit">remove</button>
                    </form>
                  </td>
                  
                </tr>
                <% }) %>


            </tbody>
          </table>
        </div>
        <hr>
        <p style="text-align: right; margin-right: 130px; color: black;" id="totelprice">Totel price=<%=usercart.totel%></p>
        <form action="/cheackout"  style="float: right; margin-right: 130px; margin-bottom: 10px;">
          <button type="submit">cheackout</button>
         </form>
       </td>
        <% } %>
      </div>
    </div>
  </div>

  <script>

   async function changeCount(id,action){
    try{
    //cheack value and action
    if(document.getElementById(`quantity_${id}`).value>1&&action=='sub'){
      const res= await fetch(`/cartInc?product=${id}&action=${action}`)
      console.log(res.data)
      document.getElementById(`quantity_${id}`).value=parseInt(document.getElementById(`quantity_${id}`).value)-1
    change()}
      //remove item from cart after try to decrease one
      else if(document.getElementById(`quantity_${id}`).value<=1&&action=='sub'){
        const res=await Swal.fire({
                  icon: 'error',
                  title: 'no',
                  text: "quantity must keep 1"
                })
              console.log(res);
       
      }
      //cheak value and action
     else if(document.getElementById(`quantity_${id}`).value>=10&&action=='add'){
      Swal.fire({
                  icon: 'error',
                  title: 'Sorry...',
                  text: "you can buy only 10"
                })
     }

     else if(document.getElementById(`quantity_${id}`).value<10&&action=='add'){
      const res= await fetch(`/cartInc?product=${id}&action=${action}`)
      document.getElementById(`quantity_${id}`).value=parseInt(document.getElementById(`quantity_${id}`).value)+1
      change()
     }
      function change(){
        //
     let quantity=parseInt( document.getElementById(`quantity_${id}`).value)
       let price=parseFloat(document.getElementById(`price_${id}`).innerHTML)
       let subtotel=quantity*price
     document.getElementById(`subtotel_${id}`).innerHTML=`${quantity}x${price}=${subtotel}`
     //
     const tdelemts=document.getElementsByClassName('newprice')
     let sum=0
     console.log(tdelemts)
     for(i=0;i<tdelemts.length;i++){
      const tdcondent=tdelemts[i].textContent;
      const newprice=parseFloat(tdcondent.split('=')[1].trim())
      sum=sum+newprice
     }
  document.getElementById("totelprice").innerHTML=`Totel price=${sum}`
   }}
   catch(err){
    alert(err)
   }
  }   
       

     
    
      

      async function removeCart(event,name){
        console.log(event)
        event.preventDefault();
        console.log(event)
       const result=await Swal.fire({
        title: 'Are you sure?',
          text: `You want to remove the ${name}`,
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#3085d6',
          cancelButtonColor: '#d33',
          confirmButtonText: 'Yes, remove it!'})
             
          if(result.isConfirmed){
            
         event.target.form.submit()        
            
          }
          
      }
      
    
      
      
    

    
  </script>

  <%-include('../user/layout/user-footer-layout.ejs') -%>














  